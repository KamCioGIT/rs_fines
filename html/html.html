<!DOCTYPE html>
<html lang="es">  
<head>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <title>Sistema de multas</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Courier New', Courier, monospace;
      color: #3b2f1e;
    }

    .formulario {
      font-family: 'Great Vibes', cursive;
      font-size: 26px;
      width: 500px;
      margin: 100px auto;
      background-color: rgba(255, 248, 220, 0.95);
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.7);
      display: none;
      position: relative;
      max-height: 90vh;
      overflow: hidden;
    }

    h1 {
      font-family: 'Great Vibes', cursive;
      font-size: 76px;
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #3b2f1e;
      padding-bottom: 10px;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    input, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #a89c84;
      background-color: #fdf6e3;
      font-size: 15px;
      border-radius: 4px;
    }

    button {
      font-family: 'Great Vibes', cursive;
      margin-top: 20px;
      padding: 10px;
      background-color: #3b2f1e;
      color: #fff;
      border: none;
      font-size: 26px;
      cursor: pointer;
      border-radius: 4px;
    }

    button:hover {
      background-color: #5a422a;
    }

    #cerrar, #cerrarSheriff {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
    }

    .itemMulta {
      background-color: #fdf6e3;
      border: 1px solid #a89c84;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .estado.pagada {
      color: green;
      font-weight: bold;
    }

    .estado.pendiente {
      color: red;
      font-weight: bold;
    }

    #multasPendientes {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 5px;
    }

    #buscadorMultas {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #a89c84;
      background-color: #fff;
      font-size: 15px;
      border-radius: 4px;
    }

    .container-prompt {
      position: absolute;
      right: 2%;
      top: 90%;
      transform: translateY(-50%);
      width: 200px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid rgba(156, 112, 60, 0.829);
      border-radius: 15px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 1000;
    }

    .title-prompt {
      font-size: 18px;
      font-weight: bold;
      color: rgba(156, 112, 60, 0.829);
      margin: 0;
      word-wrap: break-word;
      text-align: center;
    }
  </style>
</head>
<body>

  <!-- Formulario original -->
  <div class="formulario" id="formulario">
    <span id="cerrar">✖</span>
    <h1 id="formularioTitulo"></h1>
    <form id="formMulta">
      <label id="labelNombre" for="nombre"></label>
      <input type="text" id="nombre" required>

      <label id="labelApellido" for="apellido"></label>
      <input type="text" id="apellido" required>

      <label id="labelPanelID" for="id"></label>
      <input type="text" id="id" required>

      <label id="labelPanelMotivo" for="motivo"></label>
      <textarea id="motivo" rows="3" required></textarea>

      <label id="labelPanelMonto" for="monto"></label>
      <input type="number" id="monto" min="1" required>

      <button type="submit" id="botonRegistrar"></button>
    </form>
  </div>

  <!-- Panel del sheriff -->
  <div class="formulario" id="panelSheriff">
    <span id="cerrarSheriff">✖</span>
    <h1 id="panelTitulo"></h1>
    <input type="text" id="buscadorMultas" placeholder="">
    <div id="multasPendientes"></div>
    <button onclick="recolectarMultas()" id="botonRecolectar"></button>
  </div>

  <!-- Prompt flotante -->
  <div class="container-prompt" id="prompt">
    <div class="title-prompt" id="promptText"></div>
  </div>

  <script>
    window.addEventListener('message', function(event) {
      const data = event.data;

      // Elementos del formulario
      const formulario = document.getElementById('formulario');
      const formularioTitulo = document.getElementById('formularioTitulo');
      const labelNombre = document.getElementById('labelNombre');
      const labelApellido = document.getElementById('labelApellido');
      const labelPanelID = document.getElementById('labelPanelID');
      const labelPanelMotivo = document.getElementById('labelPanelMotivo');
      const labelPanelMonto = document.getElementById('labelPanelMonto');
      const botonRegistrar = document.getElementById('botonRegistrar');
      const formMulta = document.getElementById('formMulta');

      // Elementos del panel del sheriff
      const panelSheriff = document.getElementById('panelSheriff');
      const panelTitulo = document.getElementById('panelTitulo');
      const buscadorMultas = document.getElementById('buscadorMultas');
      const botonRecolectar = document.getElementById('botonRecolectar');
      const multasPendientes = document.getElementById('multasPendientes');

      // Prompt flotante
      const prompt = document.getElementById('prompt');
      const promptText = document.getElementById('promptText');

      // Aplicar traducciones si vienen en el mensaje
      if (data.textos) {
        formularioTitulo.textContent = data.textos.formularioTitulo || '';
        labelNombre.textContent = data.textos.labelNombre || '';
        labelApellido.textContent = data.textos.labelApellido || '';
        labelPanelID.textContent = data.textos.labelPanelID || '';
        labelPanelMotivo.textContent = data.textos.labelPanelMotivo || '';
        labelPanelMonto.textContent = data.textos.labelPanelMonto || '';
        botonRegistrar.textContent = data.textos.botonRegistrar || '';
        panelTitulo.textContent = data.textos.panelTitulo || '';
        buscadorMultas.placeholder = data.textos.buscadorPlaceholder || '';
        botonRecolectar.textContent = data.textos.botonRecolectar || '';
      }

      if (data.action === 'abrirFormulario') {
        formMulta.reset();
        formulario.style.display = 'block';
      }

      if (data.action === 'abrirPanelSheriff') {
        panelSheriff.style.display = 'block';
      }

      if (data.action === 'actualizarMultas') {
        multasPendientes.innerHTML = '';
        const todasLasMultas = data.multas || [];

        function renderMultas(filtro = '') {
          multasPendientes.innerHTML = '';
          const filtroLower = filtro.toLowerCase();

          todasLasMultas.forEach(multa => {
            const nombreCompleto = `${multa.nombre} ${multa.apellido}`.toLowerCase();
            if (!nombreCompleto.includes(filtroLower)) return;

            const estadoTexto = parseInt(multa.pagada) === 1
              ? data.textos?.estadoPagada || 'Pagada'
              : data.textos?.estadoPendiente || 'Sin pagar';

            const estadoClase = parseInt(multa.pagada) === 1 ? 'pagada' : 'pendiente';

            const div = document.createElement('div');
            div.className = 'itemMulta';
            div.dataset.id = multa.id;

            div.innerHTML = `
              <strong>${multa.nombre} ${multa.apellido}</strong><br>
              ${data.textos?.labelID || ""} ${multa.id_multado}<br>
              ${data.textos?.labelMotivo || ""} ${multa.motivo}<br>
              ${data.textos?.labelMonto || ""} ${multa.monto}$<br>
              ${data.textos?.autorLabel || ""} ${multa.autor}<br>
              ${data.textos?.estadoLabel || ""} <span class="estado ${estadoClase}">${estadoTexto}</span>
            `;
            multasPendientes.appendChild(div);
          });
        }

        renderMultas();

        buscadorMultas.addEventListener('input', function() {
          renderMultas(this.value);
        });
      }

      if (data.type === 'showprompt') {
        promptText.textContent = data.text || '';
        prompt.style.display = 'block';
      }

      if (data.type === 'hideprompt') {
        prompt.style.display = 'none';
      }
    });

    document.getElementById('cerrar').addEventListener('click', function() {
      document.getElementById('formulario').style.display = 'none';
      document.getElementById('formMulta').reset();
      fetch(`https://${GetParentResourceName()}/cerrarFormulario`, { method: 'POST' });
    });

    document.getElementById('cerrarSheriff').addEventListener('click', function() {
      document.getElementById('panelSheriff').style.display = 'none';
      fetch(`https://${GetParentResourceName()}/cerrarSheriff`, { method: 'POST' });
    });

    document.getElementById('formMulta').addEventListener('submit', function(e) {
      e.preventDefault();
      const datos = {
        nombre: document.getElementById('nombre').value,
        apellido: document.getElementById('apellido').value,
        id: document.getElementById('id').value,
        motivo: document.getElementById('motivo').value,
        monto: parseInt(document.getElementById('monto').value)
      };
      fetch(`https://${GetParentResourceName()}/registrarMulta`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });
      document.getElementById('formMulta').reset();
      document.getElementById('formulario').style.display = 'none';
    });

    function recolectarMultas() {
      fetch(`https://${GetParentResourceName()}/recolectarMultas`, {
        method: 'POST'
      });
      document.getElementById('panelSheriff').style.display = 'none';
    }
  </script>
</body>
</html>